<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <!-- order: 6 -->
    <!-- icon: ğŸ—ºï¸ -->
    <title>HNSW (NSW) å¯å¯¼èˆªå°ä¸–ç•Œå›¾</title>
    <meta name="description" content="å¯è§†åŒ–å±•ç¤º NSW ç®—æ³•çš„æ ¸å¿ƒåŸç†ï¼Œå¸®åŠ©ç†è§£é«˜ç»´å‘é‡çš„ç´¢å¼•æ„å»ºå’ŒæŸ¥è¯¢è¿‡ç¨‹ã€‚">  
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;700&display=swap');
        body { font-family: 'Segoe UI', sans-serif; background-color: #f8fafc; }
        .mono { font-family: 'JetBrains Mono', monospace; }
        
        /* Canvas Styles */
        #graph-canvas {
            background-color: #f8fafc;
            background-image: radial-gradient(#e2e8f0 1px, transparent 1px);
            background-size: 20px 20px;
            cursor: grab;
        }
        #graph-canvas:active {
            cursor: grabbing;
        }

        /* Code Highlighting */
        .code-line {
            padding-left: 1rem;
            border-left: 3px solid transparent;
            opacity: 0.6;
            transition: all 0.1s;
            white-space: pre;
        }
        .code-active {
            background-color: #334155;
            border-left-color: #f59e0b;
            color: #fff;
            opacity: 1;
            font-weight: bold;
        }

        /* Animations */
        .fade-enter { animation: fadeIn 0.3s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }

        /* Scrollbars */
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-thumb { background: #94a3b8; border-radius: 3px; }
        ::-webkit-scrollbar-track { background: transparent; }

        /* Resizers */
        .resizer-v {
            width: 4px;
            background-color: #cbd5e1;
            cursor: col-resize;
            transition: background-color 0.2s;
            z-index: 50;
            flex-shrink: 0;
        }
        .resizer-v:hover, .resizer-v.resizing { background-color: #3b82f6; }

        .resizer-h {
            height: 4px;
            background-color: #cbd5e1;
            cursor: row-resize;
            transition: background-color 0.2s;
            z-index: 50;
            flex-shrink: 0;
            width: 100%;
        }
        .resizer-h:hover, .resizer-h.resizing { background-color: #3b82f6; }
    </style>
</head>
<body class="h-screen flex flex-col overflow-hidden text-slate-800">

    <!-- Header -->
    <header class="bg-white border-b border-slate-200 h-14 flex items-center justify-between px-6 flex-shrink-0 z-20 shadow-sm">
        <div class="flex items-center gap-3">
            <a href="/" class="flex items-center gap-3 hover:opacity-80 transition-opacity">
                <div class="bg-indigo-600 p-1.5 rounded text-white">
                    <i data-lucide="network" class="w-5 h-5"></i>
                </div>
                <div>
                    <h1 class="text-lg font-bold text-slate-800 leading-none">HNSW (NSW) ç®—æ³•å¯è§†åŒ–</h1>
                    <div class="text-[10px] text-slate-500 mt-0.5">å¢é‡å»ºå›¾ (Add) ä¸ è´ªå¿ƒæœç´¢ (Search)</div>
                </div>
            </a>
        </div>
        <div class="flex items-center gap-4 text-xs text-slate-500">
            <div class="flex items-center gap-1"><i data-lucide="mouse-pointer-2" class="w-3 h-3"></i> <span>æ‹–æ‹½å¹³ç§»</span></div>
            <div class="flex items-center gap-1"><i data-lucide="zoom-in" class="w-3 h-3"></i> <span>æ»šè½®ç¼©æ”¾</span></div>
        </div>
    </header>

    <div class="flex-1 flex overflow-hidden" id="main-container">
        
        <!-- LEFT: Code Panel -->
        <aside id="left-panel" class="bg-[#1e293b] flex flex-col border-r border-slate-700 z-10 shadow-lg text-slate-300" style="width: 450px; min-width: 300px;">
            <div class="px-4 py-3 border-b border-slate-700 bg-[#0f172a] flex justify-between items-center flex-shrink-0">
                <h2 class="text-[10px] font-bold text-slate-400 uppercase tracking-wider flex items-center gap-2">
                    <i data-lucide="code" class="w-3 h-3"></i> æ ¸å¿ƒä»£ç é€»è¾‘
                </h2>
                <span id="code-mode-label" class="text-[10px] px-2 py-0.5 rounded bg-blue-900 text-blue-200 border border-blue-700">å»ºå›¾æ¨¡å¼</span>
            </div>
            
            <div class="flex-1 overflow-auto py-4 mono text-[11px] leading-relaxed custom-scrollbar relative" id="code-area">
                
                <!-- Code: Add Items (Expanded Search Logic) -->
                <div id="code-group-build">
                    <div id="ln-add-def" class="code-line"><span class="text-pink-400">def</span> <span class="text-blue-300">add_items</span>(self, data):</div>
                    <div id="ln-add-loop" class="code-line pl-4"><span class="text-pink-400">for</span> vec <span class="text-pink-400">in</span> data:</div>
                    <div class="code-line pl-8 text-slate-500"># 1. å¯»æ‰¾æœ€è¿‘çš„ ef ä¸ªå€™é€‰èŠ‚ç‚¹ (search_layer)</div>
                    <div id="ln-sl-init" class="code-line pl-8">frontier = MinHeap(entry_point)</div>
                    <div id="ln-sl-res" class="code-line pl-8">results = MaxHeap(entry_point)</div>
                    <div class="code-line pl-8">visited = {entry_point}</div>
                    
                    <div id="ln-sl-while" class="code-line pl-8"><span class="text-pink-400">while</span> frontier:</div>
                    <div id="ln-sl-pop" class="code-line pl-12">curr_dist, curr = frontier.pop()</div>
                    
                    <div class="code-line pl-12 text-slate-500"># å‰ªæï¼šå¦‚æœå½“å‰æœ€è¿‘çš„å€™é€‰ > ç»“æœé›†ä¸­æœ€è¿œçš„</div>
                    <div id="ln-sl-prune" class="code-line pl-12"><span class="text-pink-400">if</span> curr_dist > results.furthest():</div>
                    <div class="code-line pl-16"><span class="text-pink-400">break</span> <span class="text-slate-500"># å±€éƒ¨æœ€ä¼˜ï¼Œåœæ­¢å‘è¯¥æ–¹å‘æ‰©å±•</span></div>
                    
                    <div id="ln-sl-nb-loop" class="code-line pl-12"><span class="text-pink-400">for</span> nb <span class="text-pink-400">in</span> curr.neighbors:</div>
                    <div id="ln-sl-visit" class="code-line pl-16"><span class="text-pink-400">if</span> nb <span class="text-pink-400">not in</span> visited:</div>
                    <div class="code-line pl-20">visited.add(nb)</div>
                    <div id="ln-sl-dist" class="code-line pl-20">d = dist(vec, nb)</div>
                    
                    <div id="ln-sl-update" class="code-line pl-20"><span class="text-pink-400">if</span> d < results.furthest() <span class="text-pink-400">or</span> len < ef:</div>
                    <div class="code-line pl-24">frontier.push(nb); results.push(nb)</div>
                    <div class="code-line pl-24 text-slate-500"># ä¿æŒ results å¤§å°ä¸è¶…è¿‡ ef</div>
                    <div class="code-line pl-24"><span class="text-pink-400">if</span> len > ef: results.pop_furthest()</div>

                    <div class="code-line pl-8 text-slate-500"># 2. é€‰å‡º M ä¸ªæœ€è¿‘å¹¶è¿æ¥</div>
                    <div id="ln-add-select" class="code-line pl-8">neighbors = pick_top_m(results, M)</div>
                    <div id="ln-add-conn" class="code-line pl-8"><span class="text-pink-400">for</span> nb <span class="text-pink-400">in</span> neighbors: connect(vec, nb)</div>
                </div>

                <!-- Code: Search -->
                <div id="code-group-search" class="hidden">
                    <div id="ln-q-def" class="code-line"><span class="text-pink-400">def</span> <span class="text-blue-300">knn_query</span>(self, query, k):</div>
                    <div class="code-line pl-4 text-slate-500"># æœç´¢é€»è¾‘ä¸å»ºå›¾å‡ ä¹ä¸€è‡´ï¼Œåªæ˜¯ä¸å»ºç«‹è¿æ¥</div>
                    <div id="ln-q-init" class="code-line pl-4">frontier = MinHeap(entry); results = MaxHeap(entry)</div>
                    
                    <div id="ln-q-while" class="code-line pl-4"><span class="text-pink-400">while</span> frontier:</div>
                    <div id="ln-q-pop" class="code-line pl-8">d, curr = frontier.pop()</div>
                    
                    <div class="code-line pl-8 text-slate-500"># å‰ªæï¼šä¸å†æ·±å…¥æ›´è¿œçš„åŒºåŸŸ</div>
                    <div id="ln-q-prune" class="code-line pl-8"><span class="text-pink-400">if</span> d > results.furthest(): <span class="text-pink-400">break</span></div>
                    
                    <div id="ln-q-nb-loop" class="code-line pl-8"><span class="text-pink-400">for</span> nb <span class="text-pink-400">in</span> curr.neighbors:</div>
                    <div id="ln-q-visit" class="code-line pl-12"><span class="text-pink-400">if</span> nb <span class="text-pink-400">not in</span> visited:</div>
                    <div id="ln-q-dist" class="code-line pl-16">dist = calc_dist(query, nb)</div>
                    <div id="ln-q-update" class="code-line pl-16"><span class="text-pink-400">if</span> dist < results.furthest():</div>
                    <div class="code-line pl-20">frontier.push(nb); results.push(nb)</div>
                    
                    <div id="ln-q-ret" class="code-line pl-4"><span class="text-pink-400">return</span> results.top_k(k)</div>
                </div>

            </div>
            
            <!-- Resizer H: Code vs Log -->
            <div id="resizer-left-split" class="resizer-h border-t border-slate-700 bg-[#1e293b]"></div>

            <!-- Logger -->
            <div id="log-panel" class="bg-[#0f172a] flex flex-col min-h-[100px]" style="height: 160px;">
                <div class="px-3 py-1 text-[10px] text-slate-500 uppercase font-bold bg-[#1e293b] border-b border-slate-700 flex-shrink-0">æ‰§è¡Œæ—¥å¿—</div>
                <div id="log-container" class="flex-1 overflow-y-auto p-2 mono text-[10px] text-slate-400 space-y-1 custom-scrollbar">
                    <div class="italic">ç­‰å¾…æ“ä½œ...</div>
                </div>
            </div>
        </aside>

        <!-- Resizer V: Left vs Center -->
        <div id="resizer-col-1" class="resizer-v"></div>

        <!-- CENTER: Canvas -->
        <main class="flex-1 relative bg-slate-50 overflow-hidden min-w-[300px]">
            <canvas id="main-canvas" class="block w-full h-full"></canvas>
            
            <!-- Pruning Indicator -->
            <div id="prune-indicator" class="absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 pointer-events-none opacity-0 transition-opacity duration-300 flex flex-col items-center">
                <div class="bg-red-500 text-white rounded-full p-2 shadow-lg">
                    <i data-lucide="scissors" class="w-6 h-6"></i>
                </div>
                <span class="bg-red-100 text-red-800 text-xs font-bold px-2 py-1 rounded mt-1 border border-red-200">Pruned / Break</span>
            </div>

            <!-- Canvas Overlay -->
            <div class="absolute bottom-4 right-4 bg-white/90 backdrop-blur px-3 py-2 rounded-lg border border-slate-200 shadow-sm flex flex-col gap-2 pointer-events-none select-none">
                <div class="text-[10px] font-bold text-slate-500 uppercase mb-1">å›¾ä¾‹</div>
                <div class="flex items-center gap-2 text-xs text-slate-600"><span class="w-2.5 h-2.5 rounded-full bg-blue-500"></span> å·²è®¿é—®/è®¡ç®— (Visited)</div>
                <div class="flex items-center gap-2 text-xs text-slate-600"><span class="w-2.5 h-2.5 rounded-full bg-slate-300"></span> æœªè®¿é—® (Unvisited)</div>
                <div class="flex items-center gap-2 text-xs text-slate-600"><span class="w-2.5 h-2.5 rounded-full bg-purple-600 border-2 border-purple-200"></span> å…¥å£ç‚¹ (Entry)</div>
                <div class="flex items-center gap-2 text-xs text-slate-600"><span class="w-2.5 h-2.5 rounded-full bg-red-500 border border-white shadow-sm"></span> ç›®æ ‡/æŸ¥è¯¢ç‚¹</div>
                <div class="flex items-center gap-2 text-xs text-slate-600"><span class="w-8 h-0.5 bg-yellow-400 border-b border-dashed border-yellow-600"></span> è´ªå¿ƒæœç´¢è·¯å¾„</div>
                <div class="flex items-center gap-2 text-xs text-slate-600"><span class="w-2.5 h-2.5 rounded-full border-2 border-fuchsia-400 bg-transparent"></span> æ­£åœ¨æ£€æŸ¥é‚»å±…</div>
            </div>
        </main>

        <!-- Resizer V: Center vs Right -->
        <div id="resizer-col-2" class="resizer-v"></div>

        <!-- RIGHT: Controls & Data -->
        <aside id="right-panel" class="bg-white border-l border-slate-200 flex flex-col z-10 shadow-xl" style="width: 340px; min-width: 280px;">
            
            <!-- 1. Top Controls (Fixed Height Content) -->
            <div class="p-4 bg-slate-50 border-b border-slate-200 space-y-4 flex-shrink-0">
                
                <!-- Mode Switcher -->
                <div>
                    <label class="text-xs font-bold text-slate-500 uppercase block mb-2">å½“å‰æ¨¡å¼</label>
                    <div class="flex bg-white border border-slate-300 rounded overflow-hidden">
                        <button id="btn-mode-build" class="flex-1 py-1.5 text-xs font-bold text-blue-700 bg-blue-50 transition-colors">
                            <i data-lucide="plus-circle" class="w-3 h-3 inline mr-1"></i> å»ºå›¾
                        </button>
                        <div class="w-px bg-slate-200"></div>
                        <button id="btn-mode-search" class="flex-1 py-1.5 text-xs font-medium text-slate-500 hover:bg-slate-50 transition-colors">
                            <i data-lucide="search" class="w-3 h-3 inline mr-1"></i> æœç´¢
                        </button>
                    </div>
                    <!-- NEW: Mode Instruction -->
                    <div id="mode-instruction" class="mt-2 p-2 bg-slate-100 border border-slate-200 rounded text-[10px] text-slate-600 leading-tight flex items-start gap-1.5">
                        <i data-lucide="info" class="w-3 h-3 flex-shrink-0 mt-0.5 text-slate-400"></i>
                        <span id="mode-instruction-text">åœ¨ç”»å¸ƒç©ºç™½å¤„ <b>ç‚¹å‡»</b> ä»¥æ·»åŠ æ–°èŠ‚ç‚¹ã€‚</span>
                    </div>
                </div>

                <!-- Parameters Form -->
                <div class="grid grid-cols-3 gap-2">
                    <div>
                        <label class="text-[10px] font-bold text-slate-500 block mb-1">M (Neighbors)</label>
                        <input type="number" id="input-m" value="3" min="1" max="6" class="w-full px-1 py-1 text-xs border border-slate-300 rounded text-center focus:ring-1 focus:ring-indigo-500 outline-none">
                    </div>
                    <div>
                        <label class="text-[10px] font-bold text-slate-500 block mb-1">ef (Search)</label>
                        <input type="number" id="input-ef" value="6" min="1" max="20" class="w-full px-1 py-1 text-xs border border-slate-300 rounded text-center focus:ring-1 focus:ring-indigo-500 outline-none">
                    </div>
                    <div>
                        <label class="text-[10px] font-bold text-slate-500 block mb-1">Top K</label>
                        <input type="number" id="input-k" value="3" min="1" max="10" class="w-full px-1 py-1 text-xs border border-slate-300 rounded text-center focus:ring-1 focus:ring-indigo-500 outline-none">
                    </div>
                </div>

                <!-- Actions -->
                <div class="grid grid-cols-2 gap-2">
                    <button id="btn-quick-init" class="bg-white border border-slate-300 hover:bg-slate-100 text-slate-700 px-2 py-1.5 rounded text-xs font-medium flex items-center justify-center gap-1 transition-colors shadow-sm">
                        <i data-lucide="zap" class="w-3 h-3"></i> åˆå§‹åŒ– (40ç‚¹)
                    </button>
                    <button id="btn-reset" class="bg-white border border-slate-300 hover:bg-red-50 text-slate-700 hover:text-red-600 px-2 py-1.5 rounded text-xs font-medium flex items-center justify-center gap-1 transition-colors shadow-sm">
                        <i data-lucide="trash-2" class="w-3 h-3"></i> æ¸…ç©ºç”»å¸ƒ
                    </button>
                </div>

                <!-- Playback -->
                <div class="flex items-center gap-2">
                    <button id="btn-play" class="flex-1 bg-indigo-600 hover:bg-indigo-700 text-white px-3 py-2 rounded text-xs font-bold transition-colors shadow-sm flex items-center justify-center gap-2 disabled:opacity-50 disabled:cursor-not-allowed">
                        <i data-lucide="play" class="w-3 h-3 fill-current"></i> <span>è‡ªåŠ¨æ‰§è¡Œ</span>
                    </button>
                    <button id="btn-next" disabled class="px-3 py-2 bg-white border border-slate-300 hover:bg-slate-50 text-slate-700 rounded text-xs font-bold transition-colors shadow-sm disabled:opacity-50 disabled:cursor-not-allowed">
                        <i data-lucide="step-forward" class="w-3 h-3"></i>
                    </button>
                </div>
            </div>

            <!-- 2. Result List (Best Candidates) - Resizable -->
            <div id="results-panel" class="flex flex-col border-b border-slate-100 min-h-[80px]" style="height: 180px;">
                <div class="px-4 py-2 bg-green-50 border-b border-green-100 flex justify-between items-center flex-shrink-0">
                    <h3 class="text-xs font-bold text-green-800 flex items-center gap-2" id="list-2-title">
                        <i data-lucide="trophy" class="w-3 h-3"></i> Results (MaxHeap)
                    </h3>
                    <div class="flex gap-1">
                        <span class="text-[9px] text-green-600 bg-green-100 px-1.5 rounded">Top K / ef</span>
                    </div>
                </div>
                <div id="list-secondary" class="flex-1 overflow-y-auto p-2 space-y-1 bg-white custom-scrollbar">
                    <div class="text-xs text-slate-300 text-center mt-4 italic">Empty</div>
                </div>
            </div>

            <!-- Resizer H: Results vs Frontier -->
            <div id="resizer-right-split" class="resizer-h border-t border-slate-200 bg-slate-50"></div>

            <!-- 3. Frontier List (Takes Remaining) -->
            <div id="frontier-panel" class="flex-1 flex flex-col min-h-[80px]">
                <div class="px-4 py-2 bg-amber-50 border-b border-amber-100 flex justify-between items-center flex-shrink-0">
                    <h3 class="text-xs font-bold text-amber-800 flex items-center gap-2" id="list-1-title">
                        <i data-lucide="list-ordered" class="w-3 h-3"></i> Frontier (MinHeap)
                    </h3>
                    <span class="text-[9px] text-amber-600 bg-amber-100 px-1.5 rounded">å¾…æ¢ç´¢</span>
                </div>
                <div id="list-primary" class="flex-1 overflow-y-auto p-2 space-y-1 bg-slate-50/50 custom-scrollbar">
                    <div class="text-xs text-slate-300 text-center mt-4 italic">Empty</div>
                </div>
            </div>
            
            <!-- Stats -->
            <div class="h-8 border-t border-slate-200 bg-slate-50 flex items-center justify-between px-4 text-[10px] text-slate-500 flex-shrink-0">
                <span id="stat-nodes">Nodes: 0</span>
                <span id="stat-calc" class="font-bold text-slate-700">Dist Calcs: 0</span>
            </div>
        </aside>
    </div>

    <script>
        // --- CONFIG & STATE ---
        let CONFIG = {
            M: 3, efConstruction: 6, k: 3, nodeRadius: 5, queryRadius: 6
        };

        const STATE = {
            nodes: [], entryPoint: null, queryPoint: null, mode: 'BUILD', isExecuting: false, isPaused: false, isWaitingConfirm: false,
            list1: [], list2: [], visited: new Set(), distCalcCount: 0,
            generator: null, stepSpeed: 300, timer: null,
            activeSearchNode: null, highlightNeighbors: [], targetNodeId: null, tempLines: [], highlightNodes: [],
            scale: 1, offsetX: 0, offsetY: 0, isDragging: false, lastMouse: {x:0, y:0}
        };

        // --- RESIZING LOGIC ---
        function initResizers() {
            // 1. Columns (Left/Center, Center/Right)
            const makeResizableCol = (resizer, leftEl, rightEl, isLeftResizer) => {
                let isResizing = false;
                resizer.addEventListener('mousedown', e => { isResizing = true; document.body.style.cursor = 'col-resize'; resizer.classList.add('bg-blue-500'); });
                window.addEventListener('mousemove', e => {
                    if (!isResizing) return;
                    e.preventDefault();
                    if (isLeftResizer) {
                        const newW = Math.max(300, Math.min(800, e.clientX));
                        leftEl.style.width = `${newW}px`;
                    } else {
                        const newW = Math.max(280, Math.min(600, window.innerWidth - e.clientX));
                        rightEl.style.width = `${newW}px`;
                    }
                    resizeCanvas(); // Redraw canvas
                });
                window.addEventListener('mouseup', () => { isResizing = false; document.body.style.cursor = ''; resizer.classList.remove('bg-blue-500'); });
            };
            makeResizableCol(document.getElementById('resizer-col-1'), document.getElementById('left-panel'), null, true);
            makeResizableCol(document.getElementById('resizer-col-2'), null, document.getElementById('right-panel'), false);

            // 2. Vertical (Left: Code/Log)
            const makeResizableRow = (resizer, topEl, containerEl) => {
                let isResizing = false;
                resizer.addEventListener('mousedown', e => { isResizing = true; document.body.style.cursor = 'row-resize'; resizer.classList.add('bg-blue-500'); });
                window.addEventListener('mousemove', e => {
                    if (!isResizing) return;
                    e.preventDefault();
                    // Determine height from bottom
                    const containerRect = containerEl.getBoundingClientRect();
                    const newH = Math.max(100, Math.min(containerRect.height - 100, containerRect.bottom - e.clientY));
                    topEl.style.height = `${newH}px`;
                });
                window.addEventListener('mouseup', () => { isResizing = false; document.body.style.cursor = ''; resizer.classList.remove('bg-blue-500'); });
            };
            // Log panel is at bottom, we are resizing its height
            makeResizableRow(document.getElementById('resizer-left-split'), document.getElementById('log-panel'), document.getElementById('left-panel'));

            // 3. Vertical (Right: Results/Frontier)
            // Results is middle, Frontier is bottom (flex-1). We resize Results height.
            const makeResizableRowTop = (resizer, topEl) => {
                 let isResizing = false;
                 resizer.addEventListener('mousedown', e => { isResizing = true; document.body.style.cursor = 'row-resize'; resizer.classList.add('bg-blue-500'); });
                 window.addEventListener('mousemove', e => {
                    if (!isResizing) return;
                    e.preventDefault();
                    const rect = topEl.getBoundingClientRect();
                    const newH = Math.max(80, e.clientY - rect.top); // Min 80
                    topEl.style.height = `${newH}px`;
                 });
                 window.addEventListener('mouseup', () => { isResizing = false; document.body.style.cursor = ''; resizer.classList.remove('bg-blue-500'); });
            };
            makeResizableRowTop(document.getElementById('resizer-right-split'), document.getElementById('results-panel'));
        }
        
        // --- INPUT HANDLING ---
        function updateConfig() {
            const mVal = parseInt(document.getElementById('input-m').value) || 3;
            const efVal = parseInt(document.getElementById('input-ef').value) || 6;
            const kVal = parseInt(document.getElementById('input-k').value) || 3;
            CONFIG.M = Math.max(1, mVal);
            CONFIG.efConstruction = Math.max(1, efVal);
            CONFIG.k = Math.max(1, kVal);
        }
        document.getElementById('input-m').addEventListener('change', updateConfig);
        document.getElementById('input-ef').addEventListener('change', updateConfig);
        document.getElementById('input-k').addEventListener('change', updateConfig);


        // --- CANVAS ENGINE ---
        const canvas = document.getElementById('main-canvas');
        const ctx = canvas.getContext('2d');
        let width, height;

        function resizeCanvas() {
            const container = canvas.parentElement;
            if (!container) return;
            width = container.clientWidth;
            height = container.clientHeight;
            canvas.width = width;
            canvas.height = height;
            draw();
        }
        window.addEventListener('resize', resizeCanvas);

        // --- INTERACTION ---
        canvas.addEventListener('mousedown', e => { if (e.button === 0) { STATE.isDragging = false; STATE.lastMouse = { x: e.clientX, y: e.clientY }; } });
        canvas.addEventListener('mousemove', e => {
            if (e.buttons === 1) {
                const dx = e.clientX - STATE.lastMouse.x;
                const dy = e.clientY - STATE.lastMouse.y;
                if (Math.abs(dx) > 2 || Math.abs(dy) > 2) STATE.isDragging = true;
                if (STATE.isDragging) { STATE.offsetX += dx; STATE.offsetY += dy; STATE.lastMouse = { x: e.clientX, y: e.clientY }; draw(); }
            }
        });
        canvas.addEventListener('mouseup', e => {
            if (!STATE.isDragging) {
                const rect = canvas.getBoundingClientRect();
                const worldX = (e.clientX - rect.left - STATE.offsetX) / STATE.scale;
                const worldY = (e.clientY - rect.top - STATE.offsetY) / STATE.scale;
                handleCanvasClick(worldX, worldY);
            }
            STATE.isDragging = false;
        });
        canvas.addEventListener('wheel', e => {
            e.preventDefault();
            const scaleFactor = 1.1;
            const direction = e.deltaY > 0 ? 1/scaleFactor : scaleFactor;
            const rect = canvas.getBoundingClientRect();
            const mouseX = e.clientX - rect.left;
            const mouseY = e.clientY - rect.top;
            const worldX = (mouseX - STATE.offsetX) / STATE.scale;
            const worldY = (mouseY - STATE.offsetY) / STATE.scale;
            STATE.scale *= direction;
            STATE.scale = Math.max(0.1, Math.min(STATE.scale, 5));
            STATE.offsetX = mouseX - worldX * STATE.scale;
            STATE.offsetY = mouseY - worldY * STATE.scale;
            draw();
        }, { passive: false });

        // --- ALGORITHM HELPERS ---
        function distL2(p1, p2) { return Math.sqrt((p1.x-p2.x)**2 + (p1.y-p2.y)**2); }
        function showPruneEffect() {
            const el = document.getElementById('prune-indicator'); el.style.opacity = '1'; setTimeout(() => el.style.opacity = '0', 1000);
        }

        // --- SILENT ADD (Initialization) ---
        function addNodeSilent(x, y) {
            const newNode = { id: STATE.nodes.length + 1, x, y, neighbors: [] };
            if (STATE.nodes.length === 0) { STATE.entryPoint = newNode; STATE.nodes.push(newNode); return; }
            const entryDist = distL2(newNode, STATE.entryPoint);
            let frontier = [{ dist: entryDist, node: STATE.entryPoint }];
            let best = [{ dist: entryDist, node: STATE.entryPoint }];
            let visited = new Set([STATE.entryPoint.id]);
            while (frontier.length > 0) {
                frontier.sort((a,b) => a.dist - b.dist); const current = frontier.shift();
                if (best.length >= CONFIG.efConstruction && current.dist > best[best.length-1].dist) continue; 
                const neighbors = current.node.neighbors.map(nid => STATE.nodes.find(n => n.id === nid));
                for (let nb of neighbors) {
                    if (!visited.has(nb.id)) {
                        visited.add(nb.id);
                        const d = distL2(newNode, nb);
                        frontier.push({ dist: d, node: nb }); best.push({ dist: d, node: nb });
                        best.sort((a,b) => a.dist - b.dist);
                        if (best.length > CONFIG.efConstruction) best.pop();
                    }
                }
            }
            const neighborsToConnect = best.slice(0, CONFIG.M).map(item => item.node);
            STATE.nodes.push(newNode);
            for (let nb of neighborsToConnect) {
                if (!newNode.neighbors.includes(nb.id)) newNode.neighbors.push(nb.id);
                if (!nb.neighbors.includes(newNode.id)) nb.neighbors.push(newNode.id);
            }
        }

        // --- GENERATOR: ADD ITEM ---
        function* genAddItem(x, y) {
            const newNode = { id: STATE.nodes.length + 1, x, y, neighbors: [] };
            STATE.activeBuildNode = newNode; STATE.list1 = []; STATE.list2 = []; STATE.distCalcCount = 0; STATE.visited = new Set();
            log(`æ·»åŠ èŠ‚ç‚¹ #${newNode.id}ã€‚å‡†å¤‡æœç´¢æœ€è¿‘é‚»...`); highlightCode('ln-add-def'); yield;
            if (STATE.nodes.length === 0) {
                STATE.entryPoint = newNode; STATE.nodes.push(newNode); highlightCode('ln-add-entry'); log("å›¾ä¸ºç©ºï¼Œè®¾ç½®ä¸ºå…¥å£ç‚¹ã€‚"); draw(); yield; STATE.activeBuildNode = null; return;
            }
            highlightCode('ln-sl-init');
            const entryDist = distL2(newNode, STATE.entryPoint); STATE.distCalcCount++;
            let frontier = [{ dist: entryDist, node: STATE.entryPoint }]; let best = [{ dist: entryDist, node: STATE.entryPoint }]; STATE.visited.add(STATE.entryPoint.id);
            STATE.list1 = frontier; STATE.list2 = best; updateLists(); draw(); yield;
            while (frontier.length > 0) {
                highlightCode('ln-sl-while'); yield;
                frontier.sort((a,b) => a.dist - b.dist); const current = frontier.shift(); STATE.activeSearchNode = current.node.id; highlightCode('ln-sl-pop'); log(`Frontier å¼¹å‡º: #${current.node.id} (dist: ${current.dist.toFixed(1)})`);
                STATE.tempLines = [{p1: current.node, p2: newNode, color: '#f59e0b', dash: [5, 5], width: 2}]; draw(); yield;
                highlightCode('ln-sl-prune'); const furthestDist = best[best.length-1].dist;
                if (current.dist > furthestDist && best.length >= CONFIG.efConstruction) { showPruneEffect(); log(`è§¦å‘å‰ªæ!`, "text-red-400"); yield; continue; } yield;
                highlightCode('ln-sl-nb-loop'); const neighbors = current.node.neighbors.map(nid => STATE.nodes.find(n => n.id === nid));
                STATE.highlightNeighbors = neighbors.map(n => n.id); draw(); log(`æ£€æŸ¥èŠ‚ç‚¹ #${current.node.id} çš„ ${neighbors.length} ä¸ªé‚»å±…...`); yield;
                for (let nb of neighbors) {
                    STATE.tempLines = [{p1: current.node, p2: nb, color: '#f472b6', dash: [2, 2], width: 1.5}]; STATE.targetNodeId = nb.id; highlightCode('ln-sl-visit'); draw(); yield; 
                    if (!STATE.visited.has(nb.id)) {
                        STATE.visited.add(nb.id); const d = distL2(newNode, nb); STATE.distCalcCount++; highlightCode('ln-sl-dist'); yield;
                        highlightCode('ln-sl-update'); const currentFurthest = best[best.length-1].dist;
                        if (best.length < CONFIG.efConstruction || d < currentFurthest) {
                            frontier.push({ dist: d, node: nb }); best.push({ dist: d, node: nb }); best.sort((a,b) => a.dist - b.dist);
                            if (best.length > CONFIG.efConstruction) best.pop(); updateLists(); log(`é‚»å±… #${nb.id} åŠ å…¥å€™é€‰`);
                        } yield;
                    }
                }
                STATE.tempLines = []; STATE.targetNodeId = null; STATE.highlightNeighbors = [];
            }
            STATE.activeSearchNode = null; STATE.tempLines = []; highlightCode('ln-add-select');
            const neighborsToConnect = best.slice(0, CONFIG.M).map(item => item.node); STATE.list2 = best.slice(0, CONFIG.M); STATE.highlightNodes = neighborsToConnect.map(n => n.id); updateLists(); log(`é€‰å®š ${neighborsToConnect.length} ä¸ªæœ€è¿‘é‚»ã€‚`); draw(); yield;
            STATE.nodes.push(newNode); STATE.highlightNodes = []; highlightCode('ln-add-conn');
            for (let nb of neighborsToConnect) {
                if (!newNode.neighbors.includes(nb.id)) newNode.neighbors.push(nb.id);
                if (!nb.neighbors.includes(newNode.id)) nb.neighbors.push(newNode.id);
                STATE.tempLines.push({p1: newNode, p2: nb, color: '#10b981', width: 2});
            }
            draw(); log(`è¿æ¥å»ºç«‹å®Œæˆã€‚ç‚¹å‡» 'å®Œæˆ' ç»“æŸã€‚`, "text-indigo-500 font-bold"); yield 'WAIT_CONFIRM';
        }

        // --- GENERATOR: SEARCH ---
        function* genSearch(queryX, queryY) {
            STATE.queryPoint = { x: queryX, y: queryY }; STATE.list1 = []; STATE.list2 = []; STATE.distCalcCount = 0; STATE.visited = new Set();
            highlightCode('ln-q-def'); log("å¼€å§‹æœç´¢..."); yield;
            highlightCode('ln-q-init'); const entryDist = distL2(STATE.queryPoint, STATE.entryPoint); STATE.distCalcCount++; STATE.list1.push({ dist: entryDist, node: STATE.entryPoint }); STATE.list2.push({ dist: entryDist, node: STATE.entryPoint }); STATE.visited.add(STATE.entryPoint.id); updateLists(); draw(); yield;
            while (STATE.list1.length > 0) {
                highlightCode('ln-q-while'); yield;
                STATE.list1.sort((a,b) => a.dist - b.dist); const current = STATE.list1.shift(); STATE.activeSearchNode = current.node.id; highlightCode('ln-q-pop'); log(`Pop #${current.node.id}`); draw(); yield;
                highlightCode('ln-q-prune'); const furthestResult = STATE.list2[STATE.list2.length-1].dist; if (current.dist > furthestResult && STATE.list2.length >= CONFIG.k) {} yield;
                highlightCode('ln-q-nb-loop'); const neighbors = current.node.neighbors.map(nid => STATE.nodes.find(n => n.id === nid)); STATE.highlightNeighbors = neighbors.map(n => n.id); draw(); log(`æ£€æŸ¥ ${neighbors.length} ä¸ªé‚»å±…...`); yield;
                for (let nb of neighbors) {
                    STATE.tempLines = [{p1: current.node, p2: nb, color: '#f472b6', dash: [2, 2], width: 1.5}]; STATE.targetNodeId = nb.id; highlightCode('ln-q-visit'); draw(); yield;
                    if (!STATE.visited.has(nb.id)) {
                        STATE.visited.add(nb.id); highlightCode('ln-q-dist'); const d = distL2(STATE.queryPoint, nb); STATE.distCalcCount++; highlightCode('ln-q-update');
                        if (STATE.list2.length < CONFIG.efConstruction || d < STATE.list2[STATE.list2.length-1].dist) {
                            STATE.list1.push({ dist: d, node: nb }); STATE.list2.push({ dist: d, node: nb }); STATE.list2.sort((a,b) => a.dist - b.dist); if (STATE.list2.length > CONFIG.efConstruction) STATE.list2.pop(); updateLists();
                        } yield;
                    }
                }
                STATE.tempLines = []; STATE.targetNodeId = null; STATE.highlightNeighbors = [];
            }
            highlightCode('ln-q-return'); STATE.activeSearchNode = null; const results = STATE.list2.slice(0, CONFIG.k); STATE.tempLines = results.map(r => ({p1: STATE.queryPoint, p2: r.node, color: '#10b981', dash: [5,5], width: 1}));
            draw(); log(`æœç´¢å®Œæˆã€‚ç‚¹å‡» 'å®Œæˆ' æ¸…é™¤ã€‚`, "text-indigo-500 font-bold"); yield 'WAIT_CONFIRM';
        }

        // --- CONTROLLER ---
        function handleCanvasClick(x, y) {
            if (STATE.isExecuting || STATE.isWaitingConfirm) return;
            STATE.activeBuildNode = null; STATE.queryPoint = null; STATE.tempLines = [];
            resetExecution();
            if (STATE.mode === 'BUILD') STATE.generator = genAddItem(x, y);
            else { if (STATE.nodes.length === 0) return log("å›¾ä¸ºç©º!", "text-red-400"); STATE.generator = genSearch(x, y); }
            STATE.isExecuting = true; STATE.isPaused = false; STATE.timer = setInterval(step, STATE.stepSpeed); updateUI();
        }
        function finishAction() {
            if (STATE.mode === 'BUILD') { STATE.activeBuildNode = null; STATE.tempLines = []; STATE.isWaitingConfirm = false; STATE.isExecuting = false; draw(); log("æ–°èŠ‚ç‚¹å·²ç¡®è®¤æ·»åŠ ã€‚", "text-slate-500"); }
            else { STATE.queryPoint = null; STATE.tempLines = []; STATE.isWaitingConfirm = false; STATE.isExecuting = false; draw(); log("æŸ¥è¯¢å·²æ¸…é™¤ã€‚", "text-slate-500"); }
            resetExecution();
        }
        function setMode(mode) {
            STATE.queryPoint = null; STATE.activeBuildNode = null; STATE.activeSearchNode = null; STATE.visited.clear(); STATE.tempLines = []; STATE.highlightNodes = []; STATE.highlightNeighbors = []; STATE.isWaitingConfirm = false; resetExecution();
            STATE.mode = mode;
            const btnBuild = document.getElementById('btn-mode-build'); const btnSearch = document.getElementById('btn-mode-search'); const label = document.getElementById('code-mode-label');
            const descText = document.getElementById('mode-instruction-text');
            if (mode === 'BUILD') {
                btnBuild.className = "flex-1 py-1.5 text-xs font-bold text-blue-700 bg-blue-50 transition-colors"; btnSearch.className = "flex-1 py-1.5 text-xs font-medium text-slate-500 hover:bg-slate-50 transition-colors"; label.innerText = "å»ºå›¾æ¨¡å¼"; 
                descText.innerHTML = "åœ¨ç”»å¸ƒç©ºç™½å¤„ <b>ç‚¹å‡»</b> ä»¥æ·»åŠ æ–°èŠ‚ç‚¹ã€‚";
                document.getElementById('code-group-build').classList.remove('hidden'); document.getElementById('code-group-search').classList.add('hidden'); document.getElementById('list-1-title').innerHTML = '<i data-lucide="list-ordered" class="w-3 h-3"></i> Frontier';
            } else {
                btnSearch.className = "flex-1 py-1.5 text-xs font-bold text-indigo-700 bg-indigo-50 transition-colors"; btnBuild.className = "flex-1 py-1.5 text-xs font-medium text-slate-500 hover:bg-slate-50 transition-colors"; label.innerText = "æœç´¢æ¨¡å¼";
                descText.innerHTML = "åœ¨ç”»å¸ƒç©ºç™½å¤„ <b>ç‚¹å‡»</b> ä»¥è®¾å®šæŸ¥è¯¢ç‚¹ (çº¢è‰²ç›®æ ‡)ã€‚";
                document.getElementById('code-group-search').classList.remove('hidden'); document.getElementById('code-group-build').classList.add('hidden'); document.getElementById('list-1-title').innerHTML = '<i data-lucide="list-ordered" class="w-3 h-3"></i> Frontier';
            }
            lucide.createIcons(); draw();
        }
        function quickInit() {
            STATE.activeBuildNode = null; STATE.queryPoint = null; STATE.tempLines = []; STATE.visited.clear(); STATE.isWaitingConfirm = false; resetExecution();
            STATE.nodes = []; STATE.entryPoint = null; log("æ­£åœ¨ç”Ÿæˆ 40 ä¸ªèŠ‚ç‚¹...", "text-blue-400");
            for(let i=0; i<40; i++) { const x = Math.random() * (width - 60) + 30; const y = Math.random() * (height - 60) + 30; addNodeSilent(x, y); }
            const xs = STATE.nodes.map(n=>n.x), ys = STATE.nodes.map(n=>n.y); STATE.offsetX = (width/2) - ((Math.min(...xs)+Math.max(...xs))/2); STATE.offsetY = (height/2) - ((Math.min(...ys)+Math.max(...ys))/2); STATE.scale = 1; draw(); log("åˆå§‹åŒ–å®Œæˆ (40ç‚¹)ã€‚", "text-green-500"); updateUI();
        }
        function step() { if (!STATE.generator) return; const res = STATE.generator.next(); if (res.value === 'WAIT_CONFIRM') { clearInterval(STATE.timer); STATE.isPaused = true; STATE.isWaitingConfirm = true; updateUI(); return; } if (res.done) resetExecution(); }
        function resetExecution() { clearInterval(STATE.timer); STATE.isExecuting = false; STATE.isPaused = false; STATE.generator = null; STATE.activeSearchNode = null; STATE.highlightNodes = []; STATE.highlightNeighbors = []; highlightCode(null); updateUI(); draw(); }
        function draw() {
            ctx.clearRect(0, 0, width, height); ctx.save(); ctx.translate(STATE.offsetX, STATE.offsetY); ctx.scale(STATE.scale, STATE.scale);
            // Edges
            ctx.lineWidth = 1 / STATE.scale;
            STATE.nodes.forEach(node => {
                node.neighbors.forEach(nid => {
                    const nb = STATE.nodes.find(n => n.id === nid); if (nb) { ctx.beginPath(); ctx.moveTo(node.x, node.y); ctx.lineTo(nb.x, nb.y); ctx.strokeStyle = '#cbd5e1'; ctx.stroke(); }
                });
            });
            // Temp Lines
            STATE.tempLines.forEach(l => {
                ctx.beginPath(); if (l.dash) ctx.setLineDash(l.dash); ctx.moveTo(l.p1.x, l.p1.y); ctx.lineTo(l.p2.x, l.p2.y); ctx.strokeStyle = l.color; ctx.lineWidth = (l.width || 1)/STATE.scale; ctx.stroke(); ctx.setLineDash([]);
            });
            // Nodes
            STATE.nodes.forEach(node => {
                if (node === STATE.activeBuildNode) return;
                // Base Color Logic
                let baseColor = '#e2e8f0'; // Default Unvisited Gray
                if (!STATE.isExecuting && !STATE.isWaitingConfirm) baseColor = '#3b82f6'; // Idle Blue
                else if (STATE.visited.has(node.id)) baseColor = '#3b82f6'; // Visited Blue
                if (node === STATE.entryPoint) baseColor = '#7c3aed'; // Purple Entry

                // Highlights (Rings/Glows)
                if (STATE.activeSearchNode === node.id) { ctx.save(); ctx.beginPath(); ctx.arc(node.x, node.y, CONFIG.nodeRadius + 6/STATE.scale, 0, Math.PI * 2); ctx.globalAlpha = 0.6; ctx.fillStyle = '#f59e0b'; ctx.fill(); ctx.restore(); }
                if (STATE.highlightNeighbors.includes(node.id)) { ctx.save(); ctx.beginPath(); ctx.arc(node.x, node.y, CONFIG.nodeRadius + 4/STATE.scale, 0, Math.PI * 2); ctx.globalAlpha = 0.5; ctx.fillStyle = '#fde047'; ctx.fill(); ctx.restore(); if (STATE.activeSearchNode) { const center = STATE.nodes.find(n => n.id === STATE.activeSearchNode); if (center) { ctx.beginPath(); ctx.moveTo(center.x, center.y); ctx.lineTo(node.x, node.y); ctx.strokeStyle = '#fde047'; ctx.lineWidth = 1/STATE.scale; ctx.stroke(); } } }
                if (STATE.targetNodeId === node.id) { ctx.beginPath(); ctx.arc(node.x, node.y, CONFIG.nodeRadius + 4/STATE.scale, 0, Math.PI * 2); ctx.strokeStyle = '#f472b6'; ctx.lineWidth = 2/STATE.scale; ctx.setLineDash([2, 2]); ctx.stroke(); ctx.setLineDash([]); }
                if (STATE.highlightNodes.includes(node.id)) { ctx.save(); ctx.beginPath(); ctx.arc(node.x, node.y, CONFIG.nodeRadius + 5/STATE.scale, 0, Math.PI * 2); ctx.globalAlpha = 0.6; ctx.fillStyle = '#10b981'; ctx.fill(); ctx.restore(); }

                // Body
                ctx.beginPath(); ctx.arc(node.x, node.y, CONFIG.nodeRadius, 0, Math.PI * 2); ctx.fillStyle = baseColor; ctx.fill();
                if (node === STATE.entryPoint) { ctx.beginPath(); ctx.arc(node.x, node.y, CONFIG.nodeRadius + 2/STATE.scale, 0, Math.PI * 2); ctx.strokeStyle = '#a78bfa'; ctx.lineWidth = 1/STATE.scale; ctx.stroke(); }
                // Label
                ctx.fillStyle = '#64748b'; ctx.font = `${10/STATE.scale}px sans-serif`; ctx.textAlign = 'center'; ctx.fillText(node.id, node.x, node.y - 8/STATE.scale);
            });
            // Active Build Node
            if (STATE.activeBuildNode) {
                const node = STATE.activeBuildNode; ctx.beginPath(); ctx.arc(node.x, node.y, CONFIG.nodeRadius, 0, Math.PI * 2); ctx.fillStyle = '#ec4899'; ctx.fill(); ctx.beginPath(); ctx.arc(node.x, node.y, CONFIG.nodeRadius + 4/STATE.scale, 0, Math.PI * 2); ctx.strokeStyle = '#ec4899'; ctx.setLineDash([2, 2]); ctx.lineWidth = 1/STATE.scale; ctx.stroke(); ctx.setLineDash([]);
            }
            // Query Point
            if (STATE.queryPoint) {
                ctx.beginPath(); ctx.arc(STATE.queryPoint.x, STATE.queryPoint.y, CONFIG.queryRadius, 0, Math.PI * 2); ctx.fillStyle = '#ef4444'; ctx.fill(); ctx.strokeStyle = 'white'; ctx.lineWidth = 2/STATE.scale; ctx.stroke();
            }
            ctx.restore();
        }
        // Utils
        function updateLists() {
            const l1 = document.getElementById('list-primary'); const l2 = document.getElementById('list-secondary');
            const makeItem = (i) => `<div class="text-[10px] flex justify-between p-1 border-b border-slate-100 last:border-0 fade-enter"><span>#${i.node.id}</span><span class="font-mono text-slate-500">${i.dist.toFixed(1)}</span></div>`;
            const list1Disp = [...STATE.list1].sort((a,b) => a.dist - b.dist); l1.innerHTML = list1Disp.length ? list1Disp.map(makeItem).join('') : '<div class="text-center text-xs text-slate-300 mt-2">Empty</div>';
            const list2Disp = [...STATE.list2].sort((a,b) => a.dist - b.dist); l2.innerHTML = list2Disp.length ? list2Disp.map(makeItem).join('') : '<div class="text-center text-xs text-slate-300 mt-2">Empty</div>';
        }
        function log(msg, cls="text-slate-400") { const div = document.createElement('div'); div.className = cls; div.innerText = `> ${msg}`; const c = document.getElementById('log-container'); c.appendChild(div); c.scrollTop = c.scrollHeight; }
        function highlightCode(id) { document.querySelectorAll('.code-active').forEach(el => el.classList.remove('code-active')); if (id) document.getElementById(id)?.classList.add('code-active'); }
        function updateUI() {
            const btnPlay = document.getElementById('btn-play'); const btnNext = document.getElementById('btn-next');
            document.getElementById('stat-nodes').innerText = `Nodes: ${STATE.nodes.length}`; document.getElementById('stat-calc').innerText = `Dist Calcs: ${STATE.distCalcCount}`;
            if (STATE.isWaitingConfirm) { btnNext.disabled = true; btnPlay.innerHTML = `<i data-lucide="check" class="w-3 h-3"></i> å®Œæˆ`; btnPlay.classList.remove('bg-indigo-600', 'bg-amber-500'); btnPlay.classList.add('bg-green-600'); }
            else if (STATE.isExecuting) { btnNext.disabled = !STATE.isPaused; btnPlay.innerHTML = STATE.isPaused ? `<i data-lucide="play" class="w-3 h-3 fill-current"></i> ç»§ç»­` : `<i data-lucide="pause" class="w-3 h-3 fill-current"></i> æš‚åœ`; btnPlay.classList.toggle('bg-amber-500', !STATE.isPaused); btnPlay.classList.toggle('bg-indigo-600', STATE.isPaused); btnPlay.classList.remove('bg-green-600'); }
            else { btnNext.disabled = false; btnPlay.innerHTML = `<i data-lucide="play" class="w-3 h-3 fill-current"></i> è‡ªåŠ¨æ‰§è¡Œ`; btnPlay.classList.remove('bg-amber-500', 'bg-green-600'); btnPlay.classList.add('bg-indigo-600'); }
            lucide.createIcons();
        }
        // Binds
        document.getElementById('btn-mode-build').onclick = () => setMode('BUILD'); document.getElementById('btn-mode-search').onclick = () => setMode('SEARCH'); document.getElementById('btn-quick-init').onclick = quickInit;
        document.getElementById('btn-reset').onclick = () => { STATE.nodes = []; STATE.entryPoint = null; STATE.queryPoint = null; resetExecution(); draw(); log("ç”»å¸ƒå·²æ¸…ç©º"); };
        document.getElementById('btn-play').onclick = () => { if (STATE.isWaitingConfirm) finishAction(); else if(STATE.isPaused) { STATE.isPaused = false; STATE.timer = setInterval(step, STATE.stepSpeed); updateUI(); } else if(STATE.isExecuting) { STATE.isPaused = true; clearInterval(STATE.timer); updateUI(); } };
        document.getElementById('btn-next').onclick = () => { if(STATE.isExecuting && !STATE.isWaitingConfirm) { STATE.isPaused = true; updateUI(); step(); } };
        // Init
        lucide.createIcons(); resizeCanvas(); initResizers(); setMode('BUILD'); setTimeout(quickInit, 300);
    </script>
</body>
</html>